
{
  "rules": {
    "users": {
      ".read": "auth != null", // Allow authenticated users to query the users list
      "$uid": {
        // Individual user profile read is covered by parent, write is owner-only
        ".write": "auth != null && auth.uid === $uid",
        "email": { ".validate": "newData.isString() && newData.val().length > 0" },
        "name": { ".validate": "newData.isString() && newData.val().length > 0" },
        "avatarUrl": { ".validate": "newData.isString()" },
        "lastLogin": { ".validate": "newData.isString()" },
        "createdAt": { ".validate": "newData.isString()" },
        "geminiApiKey": { ".validate": "newData.isString()" },
        "personaQuota": { ".validate": "newData.isNumber() && newData.val() >= 0" },
        "$other": { ".validate": false }
      },
      ".indexOn": ["email"]
    },
    "user_contacts": {
      "$currentUserId": {
        ".read": "auth != null && auth.uid === $currentUserId",
        ".write": "auth != null && auth.uid === $currentUserId",
        "$contactUserId": {
          "id": { ".validate": "newData.isString() && newData.val() === $contactUserId" },
          "name": { ".validate": "newData.isString() && newData.val().length > 0" },
          "avatarUrl": { ".validate": "newData.isString()" },
          "addedAt": { ".validate": "newData.isString()" },
          "$other": { ".validate": false }
        },
        ".indexOn": ["name"]
      }
    },
    "personas": {
      "$userId": {
        ".read": "auth != null && auth.uid === $userId",
        ".write": "auth != null && auth.uid === $userId",
        "$personaId": {
          "id": { ".validate": "newData.isString() && newData.val() === $personaId" },
          "name": { ".validate": "newData.isString() && newData.val().length > 0 && newData.val().length <= 50" },
          "personaDescription": { ".validate": "newData.isString()" },
          "createdAt": { ".validate": "newData.isString()" },
          "avatarUrl": { ".validate": "newData.isString()" },
          "category": { ".validate": "newData.isString() && newData.val().length <= 50" },
          "originType": { ".validate": "newData.val() === 'user-created' || newData.val() === 'chat-derived'" },
          "chatHistory": { ".validate": "newData.isString()" },
          "mbti": { ".validate": "newData.isString()" },
          "age": { ".validate": "newData.isNumber() && newData.val() >= 1 && newData.val() <= 120" },
          "gender": { ".validate": "newData.isString()" },
          "personalityInsights": { ".validate": "newData.hasChildren() || newData.isString() || newData.val() === null" },
          "derivedFromChatId": { ".validate": "newData.isString()" },
          "derivedRepresentingUserId": { ".validate": "newData.isString()" },
          "sourceChatMessagesCount": { ".validate": "newData.isNumber()" },
          "$other": { ".validate": false }
        },
        ".indexOn": ["createdAt", "category", "derivedFromChatId"]
      }
    },
    "ai_chat_messages": {
      "$userId": {
        "$personaId": {
          ".read": "auth != null && auth.uid === $userId",
          ".write": "auth != null && auth.uid === $userId",
          "$messageId": {
            ".validate": "newData.hasChildren(['sender', 'text', 'timestamp']) && (newData.child('sender').val() === 'user' || newData.child('sender').val() === 'ai') && newData.child('text').isString() && newData.child('text').val().length > 0 && (newData.child('timestamp').val() === 'timestamp' || newData.child('timestamp').isNumber() || newData.child('timestamp').isString()) && (!newData.hasChild('context') || newData.child('context').isString())",
            "sender": { ".validate": "newData.val() === 'user' || newData.val() === 'ai'" },
            "text": { ".validate": "newData.isString() && newData.val().length > 0 && newData.val().length < 10000" },
            "timestamp": { ".validate": "newData.val() === 'timestamp' || newData.isNumber() || newData.isString()" },
            "context": { ".validate": "newData.isString()" },
            "$other": { ".validate": false }
          },
          ".indexOn": "timestamp"
        }
      }
    },
    "user_chat_messages": {
      "$chatId": {
        ".read": "auth != null && ($chatId.beginsWith(auth.uid + '_') || $chatId.endsWith('_' + auth.uid))",
        ".write": "auth != null && ($chatId.beginsWith(auth.uid + '_') || $chatId.endsWith('_' + auth.uid))",
        "$messageId": {
          ".validate": "newData.hasChildren(['senderUserId', 'text', 'timestamp']) && newData.child('senderUserId').isString() && newData.child('senderUserId').val() === auth.uid && newData.child('text').isString() && newData.child('text').val().length > 0 && newData.child('text').val().length < 10000 && (newData.child('timestamp').val() === 'timestamp' || newData.child('timestamp').isNumber() || newData.child('timestamp').isString())",
          "senderUserId": { ".validate": "newData.isString() && newData.val() === auth.uid" },
          "text": { ".validate": "newData.isString() && newData.val().length > 0 && newData.val().length < 10000" },
          "timestamp": { ".validate": "newData.val() === 'timestamp' || newData.isNumber() || newData.isString()" },
          "$other": { ".validate": false }
        },
        ".indexOn": "timestamp"
      }
    }
  }
}
